<div class="grid_10 alpha omega" id="meu_carrinho">
  <div class="grid_10 alpha omega topo_carrinho">
    <h5>Seu carrinho <%= link_to ".", :action => "esvaziar" %></h5>
  </div>
  <div class="grid_2 alpha">
    <img src="/images/decoracao/carrinho.png" alt="carrinho" width="130" height="130" style="margin:30px 0 0 10px;" />
  </div>
  <div class="grid_8 omega">
<% if @carrinho and (@carrinho.size > 0) -%>
<table class="crud">
  <tr>
    <th>Qtd.</th>
    <th>Produto</th>
    <th>Para presente?</th>
    <th style="text-align:center">Valor</th>
    <th style="text-align:right">Tirar</th>
  </tr>
<% total_qtd = total_preco = 0 %>
<% @carrinho.each_with_index do |c, i| %>
<% prod = Produto.find(c.produto_id) %>
  <tr>
    <td class="curta">
      <%= text_field_tag "qtd_produto_#{prod.id}", c.qtd, { 
                         :size => 2, 
                         :style => "font-size:16px",
                         :onblur => "alterarQtd('#{prod.id}', $F('qtd_produto_#{prod.id}'))" } %>
    </td>
    <td class="larga">
      <%= infos_produto_box(prod, :link_to_carrinho => false,
                                  :mostrar_preco => true,
                                  :mostrar_desconto => true,
                                  :mostrar_itens => true) -%>
      <p class="margin0"><%= link_to_function "[Saiba...+]" , "Modalbox.show('/comprar/produto/#{prod.id}', {title: '#{prod.nome}', width: 600}); return false;" %></p>
    </td>
    <td>
      <%= check_box_tag "presente_produto_#{prod.id}", 1, c.presente, :onclick => "javascript:embrulhar(#{prod.id})" %>
      <span class="pequeno">+<%= number_to_currency(prod.plus_presente) %>/unid.</span>
    </td>
    <td class="valor verdinho"><%= number_to_currency(calcular_preco(c, prod)) %></td>
    <td class="curta direita"><%= link_to_remote "[x]", 
                                                 :url => { :action => "retirar",  
                                                           :produto_id => prod.id },
                                                 :title => "Tirar do carrinho" if (@carrinho.size > 1) -%>&nbsp;</td>
  </tr>
<% total_qtd += c.qtd %>
<% total_preco += calcular_preco(c, prod) %>
<% end %>
  <tr id="parcial"><!-- PARCIAL = SOMA DOS PRODUTOS -->
    <td colspan="2">&nbsp;<%= pluralize(total_qtd, "item") %></td>
    <td></td>
    <td colspan="2" class="valor"><%= number_to_currency(total_preco) %></td>   
  </tr>
  <% if (@settings["frete_tipo"]=="embutido") -%><!-- FRETE INCLUSO -->
  <tr id="frete">
    <td colspan="3">&nbsp;Frete</td>
    <td colspan="2" class="valor">Incluso</td>   
  </tr>
  <% elsif (@settings["frete_tipo"]=="estadual") -%><!-- FRETE POR ESTADO -->
  <tr id="frete">
    <td colspan="3">&nbsp;Frete
    <span style="margin-left:140px">
      escolha o estado de entrega <%= render :partial => 'select_estado' -%>
      <%= observe_field "estado", 
                        :url => { :action => "atualiza_frete_por_estado" },
                        :with => "estado" -%>
    </span>
    </td>
    <td colspan="2" class="valor"><span id="frete_por_estado"><%= number_to_currency(@pedido.frete) %></span></td>
  </tr>  
  <% elsif (@settings["frete_tipo"]=="correios") -%><!-- FRETE CALCULADO PELO CORREIO -->
  <tr id="frete">
    <td colspan="2">&nbsp;Frete</td>
    <td>digite seu cep <input type="text"></td>
    <td colspan="2" class="valor"><%= number_to_currency(0) %></td>  
  </tr>
  <% end -%>
  <% if (@settings["desconto_ligado"].to_i == 1) -%><!-- DESCONTO -->
  <tr id="desconto">
    <td colspan="3">&nbsp;Desconto</td>
    <td colspan="2" class="valor"><%= number_to_currency(0) %></td>
  </tr>
  <% end -%>
  <tr id="total"><!-- TOTAL -->
    <td colspan="3">&nbsp;Total</td>
    <td colspan="2" class="valor grandao"><%= number_to_currency(@pedido.total) %></td> 
  </tr>
</table>
<% else -%>
<p class="centro" style="margin-top:20px">Seu carrinho de compras est√° vazio.</p>
<% end -%>
  </div>
</div>
<script type="text/javascript" charset="utf-8">
function embrulhar(prod_id) {
  new Ajax.Request('/comprar/embrulhar?produto_id='+prod_id, {asynchronous:true, evalScripts:true, parameters:'authenticity_token=' + encodeURIComponent('<%= form_authenticity_token %>')}); return false;
}
function alterarQtd(prod_id, qtd) {
  new Ajax.Request('/comprar/alterar_qtd?produto_id='+prod_id+'&qtd='+qtd, {asynchronous:true, evalScripts:true, parameters:'authenticity_token=' + encodeURIComponent('<%= form_authenticity_token %>')}); return false;
}
</script>